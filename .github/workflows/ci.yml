name: build

on:
    push:
        branches: [ "dev", "stage", "master", "main" ]
    pull_request: # Trigger on pull requests to any branch

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '18'

            -   name: Cache npm dependencies
                # The cache is only refreshed when the lock file changes,
                # leading to better cache reuse.
                uses: actions/cache@v4
                id: cache-primes
                with:
                    path: |
                        ~/.npm
                        **/node_modules
                        ~/.cache/ms-playwright
                        ~/.run
                    key: npm-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
                    restore-keys: |
                        npm-cache-${{ runner.os }}-
                    save-always: true

            -   name: Install dependencies if needed
                if: steps.cache-primes.outputs.cache-hit != 'true'
                run: npm ci

            -   name: Install playwright if needed
                if: steps.cache-primes.outputs.cache-hit != 'true'
                run: npx playwright install

            -   name: Install playwright deps
                run: npx playwright install-deps

            -   name: Run tests
                run: npm run test-ci

            -   name: Generate reports
                run: npm run test:report

            -   name: Get Allure history
                uses: actions/checkout@v2
                if: always()
                continue-on-error: true
                with:
                    ref: gh-pages
                    path: gh-pages

            -   name: Allure Report action from marketplace
                uses: simple-elf/allure-report-action@master
                if: always()
                id: allure-report
                with:
                    allure_results: .run/reports/allure/results
                    gh_pages: gh-pages
                    allure_report: .run/reports/allure/report
                    allure_history: .run/reports/allure/results/history
                    keep_reports: 20

            -   name: Deploy report to Github Pages
                if: always()
                uses: peaceiris/actions-gh-pages@v2
                env:
                    PERSONAL_TOKEN: ${{ secrets.GH_TOKEN }}
                    PUBLISH_BRANCH: gh-pages
                    PUBLISH_DIR: .run/reports/allure/results/history

            -   name: Post the link to the report
                if: always()
                uses: guibranco/github-status-action-v2@v1.1.13
                with:
                    authToken: ${{secrets.GH_TOKEN}}
                    context: 'Test report'
                    state: 'success'
                    sha: ${{ github.event.pull_request.head.sha }}
                    # target_url: https://github.com/jcgt96/bfexcercise-selenium-python/github-allure-history/${{ github.run_number }}